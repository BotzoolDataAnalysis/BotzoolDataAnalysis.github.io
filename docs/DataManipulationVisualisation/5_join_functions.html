<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>5 Join Functions – Botzool Data Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-0508618caa1d256af916c83e0797e277.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar docked quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../DataManipulationVisualisation/data_manipulation_visualisation.html">Data Manipulation and Visualization</a></li><li class="breadcrumb-item"><a href="../DataManipulationVisualisation/5_join_functions.html">5 Join functions</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../ubz_logo_eng_2barvy.jpg" alt="Botzool Logo" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../DataManipulationVisualisation/data_manipulation_visualisation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Manipulation and Visualization</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../DataManipulationVisualisation/1_introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1 Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../DataManipulationVisualisation/2_data_manipulation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2 Data manipulation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../DataManipulationVisualisation/3_data_visualisation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3 Data visualisation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../DataManipulationVisualisation/4_wide_vs_long.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4 Wide vs.&nbsp;long format</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../DataManipulationVisualisation/5_join_functions.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">5 Join functions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../DataManipulationVisualisation/6_advanced_visualisation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">6 Advanced data visualisation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../DataManipulationVisualisation/7_8_automatisation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">7 + 8 Automatisation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../DataManipulationVisualisation/9_10_maps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">9 + 10 Maps</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../DataManipulationVisualisation/11_database_to_plot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">11 From a database to a plot</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../DataManipulationVisualisation/12_github.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">12 GitHub</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../CommunityEcology/community_ecology.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Community Ecology</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../AIinTeaching/ai_in_teaching.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">AI in Data Analysis</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#matching-selected-information-with-left_join" id="toc-matching-selected-information-with-left_join" class="nav-link active" data-scroll-target="#matching-selected-information-with-left_join">5.1 Matching selected information with left_join</a></li>
  <li><a href="#full_join-vs.-bind_rows" id="toc-full_join-vs.-bind_rows" class="nav-link" data-scroll-target="#full_join-vs.-bind_rows">5.2 Full_join vs.&nbsp;bind_rows</a></li>
  <li><a href="#filtering-joins" id="toc-filtering-joins" class="nav-link" data-scroll-target="#filtering-joins">5.3 Filtering joins</a></li>
  <li><a href="#advanced-mutate-and-.by" id="toc-advanced-mutate-and-.by" class="nav-link" data-scroll-target="#advanced-mutate-and-.by">5.4 Advanced mutate and .by</a></li>
  <li><a href="#advanced-summarise" id="toc-advanced-summarise" class="nav-link" data-scroll-target="#advanced-summarise">5.5 Advanced summarise</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">5.6 Exercises</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading">5.7 Further reading</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../DataManipulationVisualisation/data_manipulation_visualisation.html">Data Manipulation and Visualization</a></li><li class="breadcrumb-item"><a href="../DataManipulationVisualisation/5_join_functions.html">5 Join functions</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">5 Join Functions</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In this chapter we will train how to add the information from another dataset (<em>left_join, full_join</em>), how to filter our data according to another dataset (<em>semi_join, anti_join</em>). We will also use our skills from previous chapter to calculate different statistics about our data, like mean indicator values, community weighted means of some traits, proportion of specific plant groups (<em>left_join, group_by, summarise</em>). We will play more with the species nomenclature and learn how to fix some issues or how to merge duplicate species records across vegetation layers. We will also look at mutate with more conditions (<em>ifelse, case_when</em>).</p>
<p><img src="images/clipboard-3097956773.png" class="img-fluid"></p>
<p>Credits: <a href="https://r4ds.hadley.nz/joins.html" class="uri">https://r4ds.hadley.nz/joins.html</a></p>
<section id="matching-selected-information-with-left_join" class="level2">
<h2 class="anchored" data-anchor-id="matching-selected-information-with-left_join">5.1 Matching selected information with left_join</h2>
<p>In most cases, the data you need for analyses are not organised in one file, but rather in more of them. For example we have measured characteristics for each species in the region, so called traits, and we have a species lists for all the sites. To be able to calculate mean values of selected traits for each site, we have to first append the information to individual records. For this we will use the function called <code>left_join</code> which belongs to the group of mutating joins available in tidyverse package <code>dplyr</code>.</p>
<p><img src="images/clipboard-3580080053.png" class="img-fluid">This function will automatically look for columns with exactly matching names, or we can specify the corresponding variables directly using the <em>by</em> argument. It will append all the columns available in the second “lifeforms” dataset, but only for rows, where there is a exact match. Although we have information also for other species such as <em>Abies alba</em> or <em>Carex sylvatica</em>, these do not have matching rows in the first dataset “data” and the information therefore will not be used. This means left_join is just picking those rows, that are in the first dataset. If the information is missing in the matching file, e.g.&nbsp;there is no information for <em>Trientalis europaea</em> in the lifeforms dataset, in the resulting file there will be NA.</p>
<p>Let’s train a bit. Start again a new script for this chapter.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will import the data from Forest understory again.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>spe<span class="ot">&lt;-</span> <span class="fu">read_xlsx</span>(<span class="st">"data/forest_understory/Axmanova-Forest-spe.xlsx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and we will import also data with some traits such as plant height, Ellenberg indicator values i.e.&nbsp;values indicating demands on environmental factors as soil reaction, light, nutrients… Lower values indicate lower demands, i.e.&nbsp;species can tolerate low=acidic pH, or low nutrient levels, high values indicate that the species requires or grows in habitats with high=basic soil reaction, high nutrient availability etc.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>traits<span class="ot">&lt;-</span> <span class="fu">read_xlsx</span>(<span class="st">"data/forest_understory/traits.xlsx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we try directly merging these two files it is not working. We will get a warning explaining that there are no common variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>spe<span class="sc">%&gt;%</span> <span class="fu">left_join</span>(traits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `left_join()`:
! `by` must be supplied when `x` and `y` have no common variables.
ℹ Use `cross_join()` to perform a cross-join.</code></pre>
</div>
</div>
<p>So there are more options what we can do. We check the data and see that the information we need to match is once saved as Species (in the data) and once as a Taxon (in traits).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(spe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,277 × 4
   RELEVE_NR Species              Layer CoverPerc
       &lt;dbl&gt; &lt;chr&gt;                &lt;dbl&gt;     &lt;dbl&gt;
 1         1 Quercus petraea agg.     1        63
 2         1 Acer campestre           1        18
 3         1 Crataegus laevigata      4         2
 4         1 Cornus mas               4         8
 5         1 Lonicera xylosteum       4         3
 6         1 Galium sylvaticum        6         3
 7         1 Carex digitata           6         3
 8         1 Melica nutans            6         2
 9         1 Polygonatum odoratum     6         2
10         1 Geum urbanum             6         2
# ℹ 2,267 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(traits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 316 × 7
   Taxon       Height SeedMass EIV_Light EIV_Moisture EIV_Reaction EIV_Nutrients
   &lt;chr&gt;        &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;         &lt;dbl&gt;
 1 Quercus pe…  25      975.           6            5            5             4
 2 Acer campe…   7.5     54.3          5            5            7             6
 3 Crataegus …   5.5    276.           5            5            7             5
 4 Cornus mas    4      488.           6            4            8             5
 5 Lonicera x…   2      164.           4            5            7             6
 6 Galium syl…   0.85     1.10         5            5            6             5
 7 Carex digi…   0.2      1.44         4            5            6             6
 8 Melica nut…   0.45     2.49         4            5            6             4
 9 Polygonatu…   0.45   264.           6            3            7             3
10 Geum urban…   0.55     2.05         5            5            6             7
# ℹ 306 more rows</code></pre>
</div>
</div>
<p>We can decide to rename the Species to Taxon and use this column for matching</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>spe<span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">Taxon=</span>Species) <span class="sc">%&gt;%</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(traits, <span class="at">by=</span><span class="st">"Taxon"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,277 × 10
   RELEVE_NR Taxon        Layer CoverPerc Height SeedMass EIV_Light EIV_Moisture
       &lt;dbl&gt; &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;
 1         1 Quercus pet…     1        63  25      975.           6            5
 2         1 Acer campes…     1        18   7.5     54.3          5            5
 3         1 Crataegus l…     4         2   5.5    276.           5            5
 4         1 Cornus mas       4         8   4      488.           6            4
 5         1 Lonicera xy…     4         3   2      164.           4            5
 6         1 Galium sylv…     6         3   0.85     1.10         5            5
 7         1 Carex digit…     6         3   0.2      1.44         4            5
 8         1 Melica nuta…     6         2   0.45     2.49         4            5
 9         1 Polygonatum…     6         2   0.45   264.           6            3
10         1 Geum urbanum     6         2   0.55     2.05         5            5
# ℹ 2,267 more rows
# ℹ 2 more variables: EIV_Reaction &lt;dbl&gt;, EIV_Nutrients &lt;dbl&gt;</code></pre>
</div>
</div>
<p>or we can even skip the <em>by</em> argument, as there is only one commong matching column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>spe<span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">Taxon=</span>Species) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(traits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(Taxon)`</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,277 × 10
   RELEVE_NR Taxon        Layer CoverPerc Height SeedMass EIV_Light EIV_Moisture
       &lt;dbl&gt; &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;
 1         1 Quercus pet…     1        63  25      975.           6            5
 2         1 Acer campes…     1        18   7.5     54.3          5            5
 3         1 Crataegus l…     4         2   5.5    276.           5            5
 4         1 Cornus mas       4         8   4      488.           6            4
 5         1 Lonicera xy…     4         3   2      164.           4            5
 6         1 Galium sylv…     6         3   0.85     1.10         5            5
 7         1 Carex digit…     6         3   0.2      1.44         4            5
 8         1 Melica nuta…     6         2   0.45     2.49         4            5
 9         1 Polygonatum…     6         2   0.45   264.           6            3
10         1 Geum urbanum     6         2   0.55     2.05         5            5
# ℹ 2,267 more rows
# ℹ 2 more variables: EIV_Reaction &lt;dbl&gt;, EIV_Nutrients &lt;dbl&gt;</code></pre>
</div>
</div>
<p>We can also skip rename step and directly say in the left_join function what is matching with what. Note that it will keep Species as outcome, because this was how we named it in the primary data file</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>spe<span class="sc">%&gt;%</span> <span class="fu">left_join</span>(traits, <span class="at">by=</span><span class="fu">c</span>(<span class="st">"Species"</span> <span class="ot">=</span><span class="st">"Taxon"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,277 × 10
   RELEVE_NR Species      Layer CoverPerc Height SeedMass EIV_Light EIV_Moisture
       &lt;dbl&gt; &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;
 1         1 Quercus pet…     1        63  25      975.           6            5
 2         1 Acer campes…     1        18   7.5     54.3          5            5
 3         1 Crataegus l…     4         2   5.5    276.           5            5
 4         1 Cornus mas       4         8   4      488.           6            4
 5         1 Lonicera xy…     4         3   2      164.           4            5
 6         1 Galium sylv…     6         3   0.85     1.10         5            5
 7         1 Carex digit…     6         3   0.2      1.44         4            5
 8         1 Melica nuta…     6         2   0.45     2.49         4            5
 9         1 Polygonatum…     6         2   0.45   264.           6            3
10         1 Geum urbanum     6         2   0.55     2.05         5            5
# ℹ 2,267 more rows
# ℹ 2 more variables: EIV_Reaction &lt;dbl&gt;, EIV_Nutrients &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Note that left_join is a great help. But you should always think about the data. If you have more, potentially matching rows you can do a lot of unwanted mess with left_join. For example if you do not use unique ID, but descriptor such as forest type. So please do read the warning messages. :-)</p>
</section>
<section id="full_join-vs.-bind_rows" class="level2">
<h2 class="anchored" data-anchor-id="full_join-vs.-bind_rows">5.2 Full_join vs.&nbsp;bind_rows</h2>
<p>Sometimes it is needed to match both datasets. In contrast to left_join, full_join will add also additional rows that appear in the other dataset.</p>
<p><img src="images/clipboard-1035988765.png" class="img-fluid"></p>
<p>Credits: <a href="https://r4ds.hadley.nz/joins.html" class="uri">https://r4ds.hadley.nz/joins.html</a></p>
<p>We will upload the forest env data and make two subsets to train a bit.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>env<span class="ot">&lt;-</span> <span class="fu">read_xlsx</span>(<span class="st">"data/forest_understory/Axmanova-Forest-env.xlsx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the first subset we will use only first two forest types, namely oak and oak-hoarnbeam forests and selection of variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>forest1<span class="ot">&lt;-</span>env <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ForestType <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))<span class="sc">%&gt;%</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">PlotID=</span>RELEVE_NR, ForestType, ForestTypeName, pH_KCl, Biomass)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the second subset we will use one forest type shared with the previous subset and two others, namely oak-hornbeam, ravine and alluvial forests, and a bit different selection of variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>forest2<span class="ot">&lt;-</span>env <span class="sc">%&gt;%</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ForestType <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>))<span class="sc">%&gt;%</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">PlotID=</span>RELEVE_NR, ForestType, ForestTypeName, pH_KCl,Canopy_E3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now <strong>left_join</strong> the data and check the preview #use view () to see more of the dataset. Here we have just added the extra information available in the second dataset to our selection of plots and variables in the first dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>forest1 <span class="sc">%&gt;%</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(forest2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(PlotID, ForestType, ForestTypeName, pH_KCl)`</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 44 × 6
   PlotID ForestType ForestTypeName      pH_KCl Biomass Canopy_E3
    &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;                &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;
 1      1          2 oak hornbeam forest   5.28    12.8        80
 2      2          1 oak forest            3.24     9.9        NA
 3      3          1 oak forest            4.01    15.2        NA
 4      4          1 oak forest            3.76    16          NA
 5      5          1 oak forest            3.50    20.7        NA
 6      6          1 oak forest            3.8     46.4        NA
 7      7          1 oak forest            3.48    49.2        NA
 8      8          2 oak hornbeam forest   3.68    48.7        85
 9      9          2 oak hornbeam forest   4.24    13.8        80
10     10          1 oak forest            4.00    79.1        NA
# ℹ 34 more rows</code></pre>
</div>
</div>
<p>In the next step we will take both subsets and merge them together using <strong>full_join</strong>. What is the output? We will get a dataset will whole information available, this includes all four forests types. However, since the Forest type 1 is only present in the first subset, the corresponding rows will have only the information available there (forest type, pH). The type 2 is in both datasets so it will have all information from both datasets (forest type, pH, biomass, canopy). Type 3 and 4 will have information only from the second dataset (forest type, pH, canopy). Use view () to see the complete merged dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>forest1 <span class="sc">%&gt;%</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(forest2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(PlotID, ForestType, ForestTypeName, pH_KCl)`</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 65 × 6
   PlotID ForestType ForestTypeName      pH_KCl Biomass Canopy_E3
    &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;                &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;
 1      1          2 oak hornbeam forest   5.28    12.8        80
 2      2          1 oak forest            3.24     9.9        NA
 3      3          1 oak forest            4.01    15.2        NA
 4      4          1 oak forest            3.76    16          NA
 5      5          1 oak forest            3.50    20.7        NA
 6      6          1 oak forest            3.8     46.4        NA
 7      7          1 oak forest            3.48    49.2        NA
 8      8          2 oak hornbeam forest   3.68    48.7        85
 9      9          2 oak hornbeam forest   4.24    13.8        80
10     10          1 oak forest            4.00    79.1        NA
# ℹ 55 more rows</code></pre>
</div>
</div>
<p>Note that the joining worked good, since we had the same names in both datasets. For example if biomass would be called soil_pH in one and pH_KCl in the other dataset, it will treat them as different variables as you can see below</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>forest1<span class="sc">%&gt;%</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">soil_pH=</span>pH_KCl) <span class="sc">%&gt;%</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(forest2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(PlotID, ForestType, ForestTypeName)`</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 65 × 7
   PlotID ForestType ForestTypeName      soil_pH Biomass pH_KCl Canopy_E3
    &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;                 &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;
 1      1          2 oak hornbeam forest    5.28    12.8   5.28        80
 2      2          1 oak forest             3.24     9.9  NA           NA
 3      3          1 oak forest             4.01    15.2  NA           NA
 4      4          1 oak forest             3.76    16    NA           NA
 5      5          1 oak forest             3.50    20.7  NA           NA
 6      6          1 oak forest             3.8     46.4  NA           NA
 7      7          1 oak forest             3.48    49.2  NA           NA
 8      8          2 oak hornbeam forest    3.68    48.7   3.68        85
 9      9          2 oak hornbeam forest    4.24    13.8   4.24        80
10     10          1 oak forest             4.00    79.1  NA           NA
# ℹ 55 more rows</code></pre>
</div>
</div>
<p>Imagine situation when data were sampled in different years/months or by different colleagues, or in different regions separately. If these <strong>subsets have exactly the same structure</strong>, we may use <strong><code>bind_rows</code></strong> function to merge them together, one below each other.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>forest1<span class="ot">&lt;-</span>env <span class="sc">%&gt;%</span> </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ForestType <span class="sc">==</span><span class="dv">1</span>)<span class="sc">%&gt;%</span> </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">PlotID=</span>RELEVE_NR, ForestType, ForestTypeName, pH_KCl, Biomass)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>forest2<span class="ot">&lt;-</span>env <span class="sc">%&gt;%</span> </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ForestType <span class="sc">==</span><span class="dv">2</span>)<span class="sc">%&gt;%</span> </span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">PlotID=</span>RELEVE_NR, ForestType, ForestTypeName, pH_KCl, Biomass)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Bind and check the whole dataset with view()</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>forest1<span class="sc">%&gt;%</span> </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(forest2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 44 × 5
   PlotID ForestType ForestTypeName pH_KCl Biomass
    &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;           &lt;dbl&gt;   &lt;dbl&gt;
 1      2          1 oak forest       3.24     9.9
 2      3          1 oak forest       4.01    15.2
 3      4          1 oak forest       3.76    16  
 4      5          1 oak forest       3.50    20.7
 5      6          1 oak forest       3.8     46.4
 6      7          1 oak forest       3.48    49.2
 7     10          1 oak forest       4.00    79.1
 8     11          1 oak forest       3.83     7.4
 9     28          1 oak forest       3.56    29.7
10     31          1 oak forest       3.20    14.9
# ℹ 34 more rows</code></pre>
</div>
</div>
<p>Note that the rbind function in baseR works similarly, but less effectively and it is designed for dataframes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(forest1,forest2) <span class="co">#remove unwanted data from the environment</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="filtering-joins" class="level2">
<h2 class="anchored" data-anchor-id="filtering-joins">5.3 Filtering joins</h2>
<p>Sometimes we need to filter the data according to another dataset. For example I have looked at the environmental file and decided that for a follow-up analysis I need only alluvial forest. I therefore filtered rows in the env file.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>env_selected <span class="ot">&lt;-</span>env <span class="sc">%&gt;%</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ForestType<span class="sc">==</span><span class="dv">4</span>)<span class="sc">%&gt;%</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">PlotID=</span>RELEVE_NR,ForestType, ForestTypeName, pH_KCl, Biomass) <span class="sc">%&gt;%</span> <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 5
   PlotID ForestType ForestTypeName  pH_KCl Biomass
    &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;            &lt;dbl&gt;   &lt;dbl&gt;
 1    101          4 alluvial forest   6.67    91.1
 2    103          4 alluvial forest   7.12   114. 
 3    104          4 alluvial forest   7.14   188. 
 4    110          4 alluvial forest   5.82   126. 
 5    111          4 alluvial forest   7.01    84.8
 6    113          4 alluvial forest   6.61    74.5
 7    125          4 alluvial forest   4.99   123. 
 8    128          4 alluvial forest   7.03   121. 
 9    130          4 alluvial forest   5.74   238  
10    132          4 alluvial forest   5.56   287. 
11    127          4 alluvial forest   5.56   176  </code></pre>
</div>
</div>
<p>However, I also need to filter the rows in the species data, where there is no information about forest types. The only common identificator is the PlotID (i.e.&nbsp;sample/site ID).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>spe <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">PlotID=</span>RELEVE_NR) <span class="sc">%&gt;%</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">semi_join</span>(env_selected)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(PlotID)`</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 530 × 4
   PlotID Species             Layer CoverPerc
    &lt;dbl&gt; &lt;chr&gt;               &lt;dbl&gt;     &lt;dbl&gt;
 1    101 Fraxinus excelsior      1        38
 2    103 Alnus glutinosa         1        63
 3    104 Alnus glutinosa         1        63
 4    110 Alnus glutinosa         1        38
 5    111 Alnus glutinosa         1        38
 6    113 Alnus glutinosa         1        63
 7    125 Alnus glutinosa         1        38
 8    128 Corylus avellana        1        38
 9    130 Acer pseudoplatanus     1        38
10    132 Alnus glutinosa         1        38
# ℹ 520 more rows</code></pre>
</div>
</div>
<p>With distinct function you can check if the IDs are the same.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>spe <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">PlotID=</span>RELEVE_NR) <span class="sc">%&gt;%</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">semi_join</span>(env_selected) <span class="sc">%&gt;%</span> </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(PlotID)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(PlotID)`</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 1
   PlotID
    &lt;dbl&gt;
 1    101
 2    103
 3    104
 4    110
 5    111
 6    113
 7    125
 8    128
 9    130
10    132
11    127</code></pre>
</div>
</div>
<p>Sometimes you may need the opposite - to keep only rows/IDs that are not in the other file. For this you should use <code>anti_join</code> function. An example can be that you want to remove from your list certain group of species such as annuals or nonvasculars (mosses and lichens).</p>
<p><img src="images/clipboard-1417970058.png" class="img-fluid"></p>
</section>
<section id="advanced-mutate-and-.by" class="level2">
<h2 class="anchored" data-anchor-id="advanced-mutate-and-.by">5.4 Advanced mutate and .by</h2>
<p>Below are few examples, how we used <strong>mutate</strong> so far</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>env <span class="sc">%&gt;%</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">author=</span> <span class="st">"Axmanova"</span>, <span class="co">#add one column with specified value</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">forestType=</span><span class="fu">as.character</span>(ForestType), <span class="co">#change the type of variable</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">biomass =</span> Biomass<span class="sc">*</span><span class="dv">1000</span>, <span class="co"># multiply to change to mg</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">forestTypeName=</span> <span class="fu">str_replace_all</span>(ForestTypeName,<span class="st">" "</span>,<span class="st">"_"</span>))<span class="sc">%&gt;%</span> <span class="co">#change string</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">PlotID=</span>RELEVE_NR, author, forestType, biomass,forestTypeName)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 65 × 5
   PlotID author   forestType biomass forestTypeName     
    &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;        &lt;dbl&gt; &lt;chr&gt;              
 1      1 Axmanova 2            12800 oak_hornbeam_forest
 2      2 Axmanova 1             9900 oak_forest         
 3      3 Axmanova 1            15200 oak_forest         
 4      4 Axmanova 1            16000 oak_forest         
 5      5 Axmanova 1            20700 oak_forest         
 6      6 Axmanova 1            46400 oak_forest         
 7      7 Axmanova 1            49200 oak_forest         
 8      8 Axmanova 2            48700 oak_hornbeam_forest
 9      9 Axmanova 2            13800 oak_hornbeam_forest
10     10 Axmanova 1            79100 oak_forest         
# ℹ 55 more rows</code></pre>
</div>
</div>
<p>We also used mutate to adjust more variables at once</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>env <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(Radiation,Heat), round, <span class="at">digits=</span><span class="dv">2</span>))<span class="sc">%&gt;%</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span> (<span class="at">PlotID=</span>RELEVE_NR, Radiation, Heat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 65 × 3
   PlotID Radiation  Heat
    &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;
 1      1      0.88  0.86
 2      2      0.93  0.81
 3      3      0.92  0.85
 4      4      0.93  0.95
 5      5      0.87  0.87
 6      6      0.92  0.88
 7      7      0.83  0.8 
 8      8      0.87  0.87
 9      9      0.61  0.42
10     10      0.91  0.93
# ℹ 55 more rows</code></pre>
</div>
</div>
<p>Alternatively if you have a large table with only measured variables you can specify what should not be used, here Species, and mutate will be applied to everything left. This is especially useful for changing formats e.g from character to numeric (function <em>as.numeric</em>)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>iris <span class="sc">%&gt;%</span> </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span>  <span class="co">#first change from dataframe to tibble </span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="sc">-</span>Species, round))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 150 × 5
   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
 1            5           4            1           0 setosa 
 2            5           3            1           0 setosa 
 3            5           3            1           0 setosa 
 4            5           3            2           0 setosa 
 5            5           4            1           0 setosa 
 6            5           4            2           0 setosa 
 7            5           3            1           0 setosa 
 8            5           3            2           0 setosa 
 9            4           3            1           0 setosa 
10            5           3            2           0 setosa 
# ℹ 140 more rows</code></pre>
</div>
</div>
<p>You can even create a list of functions which should be applied. <em><code>relocate</code></em> here was used to shift all the Sepal variables before the first variable / just for easier check.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>iris<span class="sc">%&gt;%</span> </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"Sepal"</span>),</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>                <span class="fu">list</span>(<span class="at">rounded =</span> round, <span class="at">log =</span> log1p)))<span class="sc">%&gt;%</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(<span class="fu">starts_with</span>(<span class="st">"Sepal"</span>),<span class="at">.before =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 150 × 9
   Sepal.Length Sepal.Width Sepal.Length_rounded Sepal.Length_log
          &lt;dbl&gt;       &lt;dbl&gt;                &lt;dbl&gt;            &lt;dbl&gt;
 1          5.1         3.5                    5             1.81
 2          4.9         3                      5             1.77
 3          4.7         3.2                    5             1.74
 4          4.6         3.1                    5             1.72
 5          5           3.6                    5             1.79
 6          5.4         3.9                    5             1.86
 7          4.6         3.4                    5             1.72
 8          5           3.4                    5             1.79
 9          4.4         2.9                    4             1.69
10          4.9         3.1                    5             1.77
# ℹ 140 more rows
# ℹ 5 more variables: Sepal.Width_rounded &lt;dbl&gt;, Sepal.Width_log &lt;dbl&gt;,
#   Petal.Length &lt;dbl&gt;, Petal.Width &lt;dbl&gt;, Species &lt;fct&gt;</code></pre>
</div>
</div>
<p>What we can further do is to mutate a variable using <strong>group_by</strong>. This can be like below, step by step…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>env <span class="sc">%&gt;%</span> </span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ForestType) <span class="sc">%&gt;%</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">PlotID=</span>RELEVE_NR, ForestType, Biomass)<span class="sc">%&gt;%</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">meanBiomass=</span><span class="fu">mean</span>(Biomass))<span class="sc">%&gt;%</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">comparison=</span> (<span class="fu">case_when</span>(Biomass<span class="sc">&gt;</span>meanBiomass <span class="sc">~</span><span class="st">"higher"</span>, </span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>                               Biomass<span class="sc">&lt;</span>meanBiomass <span class="sc">~</span><span class="st">"lower"</span>,</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>                               <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"equal"</span>)))<span class="sc">%&gt;%</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(ForestType,<span class="fu">desc</span>(Biomass))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 65 × 5
# Groups:   ForestType [4]
   PlotID ForestType Biomass meanBiomass comparison
    &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;       &lt;dbl&gt; &lt;chr&gt;     
 1     10          1    79.1        26.7 higher    
 2      7          1    49.2        26.7 higher    
 3      6          1    46.4        26.7 higher    
 4     44          1    34.1        26.7 higher    
 5     82          1    33.9        26.7 higher    
 6     28          1    29.7        26.7 higher    
 7     42          1    21.5        26.7 lower     
 8      5          1    20.7        26.7 lower     
 9     81          1    20.6        26.7 lower     
10      4          1    16          26.7 lower     
# ℹ 55 more rows</code></pre>
</div>
</div>
<p>or like this, where we do not use stand alone group_by but much more effective <strong>.by</strong> directly included in the mutate function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>env <span class="sc">%&gt;%</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">PlotID=</span>RELEVE_NR, ForestType, Biomass)<span class="sc">%&gt;%</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">meanBiomass =</span> <span class="fu">mean</span>(Biomass, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">comparison =</span> <span class="fu">case_when</span>(</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>      Biomass <span class="sc">&gt;</span> meanBiomass <span class="sc">~</span> <span class="st">"higher"</span>,</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>      Biomass <span class="sc">&lt;</span> meanBiomass <span class="sc">~</span> <span class="st">"lower"</span>,</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"equal"</span>),</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> ForestType)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 65 × 5
   PlotID ForestType Biomass meanBiomass comparison
    &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;       &lt;dbl&gt; &lt;chr&gt;     
 1      1          2    12.8        44.4 lower     
 2      2          1     9.9        26.7 lower     
 3      3          1    15.2        26.7 lower     
 4      4          1    16          26.7 lower     
 5      5          1    20.7        26.7 lower     
 6      6          1    46.4        26.7 higher    
 7      7          1    49.2        26.7 higher    
 8      8          2    48.7        44.4 higher    
 9      9          2    13.8        44.4 lower     
10     10          1    79.1        26.7 higher    
# ℹ 55 more rows</code></pre>
</div>
</div>
<p>We need to realise, that after you use <strong>group_by</strong>, the data <em>stay grouped</em> until you explicitly call <code>ungroup()</code>, or use a verb that drops grouping automatically by default settings (usually <code>summarise</code>or <code>count</code>). While <code>summarise</code>removes the grouping, <code>mutate</code> does not, therefore grouping still applies until the end of that call.</p>
<p>Advantage of <strong>.by</strong> is that it works only within the mutate function.</p>
</section>
<section id="advanced-summarise" class="level2">
<h2 class="anchored" data-anchor-id="advanced-summarise">5.5 Advanced summarise</h2>
<p>Summarise reduces the information to single values per group, defined by the group_by function. We used summarise or summarise across and calculated min, mean, median,max values or sum of the values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>env <span class="sc">%&gt;%</span> </span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ForestTypeName) <span class="sc">%&gt;%</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">meanBiomass=</span> <span class="fu">mean</span>(Biomass))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  ForestTypeName      meanBiomass
  &lt;chr&gt;                     &lt;dbl&gt;
1 alluvial forest           148. 
2 oak forest                 26.7
3 oak hornbeam forest        44.4
4 ravine forest              79.1</code></pre>
</div>
</div>
<p>We did not yet explain anything about <code>n_distinct</code> function. It can be used for getting unique combinations of selected variables directly in summarise. Like here unique number of species in each plot</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>spe <span class="sc">%&gt;%</span> </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_species =</span> <span class="fu">n_distinct</span>(Species), <span class="at">.by =</span> RELEVE_NR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 65 × 2
   RELEVE_NR unique_species
       &lt;dbl&gt;          &lt;int&gt;
 1         1             42
 2         2             16
 3         3             15
 4         4             20
 5         5             14
 6         6             19
 7         7             22
 8         8             23
 9         9             22
10        10             18
# ℹ 55 more rows</code></pre>
</div>
</div>
<p>or unique pairs or combinations of selected variables, such as species +their combinations in vegetation layers -here in the whole dataset</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>spe <span class="sc">%&gt;%</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_species_layer =</span> <span class="fu">n_distinct</span>(<span class="fu">interaction</span>(Species, Layer)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  unique_species_layer
                 &lt;int&gt;
1                  369</code></pre>
</div>
</div>
<p>When you become confident with joins and summarise you can even do something like this. I am working with env data, but at the same time I want to use the summarised information from species data. And I can calculate it and match directly in the pipeline without stepping outside, as there is no need to calculating and saving intermediate steps separately.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>env <span class="sc">%&gt;%</span> </span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(spe <span class="sc">%&gt;%</span> </span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>              <span class="fu">group_by</span>(RELEVE_NR) <span class="sc">%&gt;%</span> </span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>              <span class="fu">count</span>(<span class="at">name =</span> <span class="st">"Richness"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">PlotID=</span>RELEVE_NR,ForestType, ForestTypeName, Richness, Biomass, pH_KCl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(RELEVE_NR)`</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 65 × 6
   PlotID ForestType ForestTypeName      Richness Biomass pH_KCl
    &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;                  &lt;int&gt;   &lt;dbl&gt;  &lt;dbl&gt;
 1      1          2 oak hornbeam forest       44    12.8   5.28
 2      2          1 oak forest                17     9.9   3.24
 3      3          1 oak forest                16    15.2   4.01
 4      4          1 oak forest                22    16     3.76
 5      5          1 oak forest                15    20.7   3.50
 6      6          1 oak forest                22    46.4   3.8 
 7      7          1 oak forest                23    49.2   3.48
 8      8          2 oak hornbeam forest       24    48.7   3.68
 9      9          2 oak hornbeam forest       28    13.8   4.24
10     10          1 oak forest                19    79.1   4.00
# ℹ 55 more rows</code></pre>
</div>
</div>
<p>Another useful thing is to know how to sum values across more columns and save it in another column, i.e.&nbsp;row-wise sum. The relevant function is called <strong><code>rowSums</code></strong>. We will look at the example of frozen fauna data availability and first we will turn the table into tidy by filling 0 and changing x to 1.</p>
<p>Alternative is #mutate(across( c(pollen_spores, macrofossils, dna), ~ if_else(!is.na(.x) &amp; .x == “x”, 1, 0)))</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>data<span class="ot">&lt;-</span>  <span class="fu">read_xlsx</span>(<span class="st">"data/frozen_fauna/FrozenFauna_metadata.xlsx"</span>, <span class="at">sheet=</span><span class="dv">1</span>)<span class="sc">%&gt;%</span> </span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clean_names</span>()<span class="sc">%&gt;%</span> </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(pollen_spores, macrofossils, dna), <span class="sc">~</span> <span class="fu">replace_na</span>(.x, <span class="st">"0"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(pollen_spores, macrofossils, dna), <span class="sc">~</span> <span class="fu">if_else</span>(.x <span class="sc">==</span> <span class="st">"x"</span>, <span class="dv">1</span>, <span class="dv">0</span>)))<span class="sc">%&gt;%</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dataAvailableSum =</span> <span class="fu">rowSums</span>(<span class="fu">across</span>(pollen_spores<span class="sc">:</span>dna)))<span class="sc">%&gt;%</span> </span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 27 × 7
      id code   species        pollen_spores macrofossils   dna dataAvailableSum
   &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;                  &lt;dbl&gt;        &lt;dbl&gt; &lt;dbl&gt;            &lt;dbl&gt;
 1     1 D-M5   Mammuthus pri…             0            0     1                1
 2     2 D-BP4  Bison priscus              0            0     1                1
 3     3 D-MP11 Mammuthus pri…             1            1     0                2
 4     4 SK2    Stephanorhinu…             0            1     0                1
 5     5 MP5    Mammuthus pri…             1            1     0                2
 6     6 CA2    Coelodonta an…             0            1     0                1
 7     7 MP9    Mammuthus pri…             1            1     1                3
 8     8 D-MP10 Mammuthus pri…             1            1     0                2
 9     9 MP3    Mammuthus pri…             1            1     0                2
10    10 MP4    Mammuthus pri…             1            1     0                2
# ℹ 17 more rows</code></pre>
</div>
</div>
<p><strong>.x</strong> refers to the entire column (vector) being transformed inside a function like mutate(across(…)) or map().</p>
<p>Summarise is often used for getting so-called <strong>community means</strong> or community weighted means. For example we have traits for individual species and we want to calculate a mean for each site and compare it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>spe<span class="sc">%&gt;%</span> </span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(traits, <span class="at">by=</span><span class="fu">c</span>(<span class="st">"Species"</span> <span class="ot">=</span><span class="st">"Taxon"</span>))<span class="sc">%&gt;%</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">meanHeight=</span> <span class="fu">mean</span>(Height), <span class="at">.by=</span>RELEVE_NR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 65 × 2
   RELEVE_NR meanHeight
       &lt;dbl&gt;      &lt;dbl&gt;
 1         1      NA   
 2         2       6.00
 3         3       3.50
 4         4       8.14
 5         5       3.82
 6         6      NA   
 7         7      NA   
 8         8       3.52
 9         9       8.25
10        10      NA   
# ℹ 55 more rows</code></pre>
</div>
</div>
<p>So far, we had data with no missing values, but most probably you will come across situations where there will be some NAs. For this you will need to use argument <strong>na.rm=TRUE</strong> which indicates that you want to skip the NAs from counting. Otherwise a single NA would mean also the result will be NA. The same happened here, so we need to fix it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>spe<span class="sc">%&gt;%</span> </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(traits, <span class="at">by=</span><span class="fu">c</span>(<span class="st">"Species"</span> <span class="ot">=</span><span class="st">"Taxon"</span>))<span class="sc">%&gt;%</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">meanHeight=</span> <span class="fu">mean</span>(Height, <span class="at">na.rm=</span>T), <span class="at">.by=</span>RELEVE_NR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 65 × 2
   RELEVE_NR meanHeight
       &lt;dbl&gt;      &lt;dbl&gt;
 1         1       4.60
 2         2       6.00
 3         3       3.50
 4         4       8.14
 5         5       3.82
 6         6       3.3 
 7         7       4.25
 8         8       3.52
 9         9       8.25
10        10       3.53
# ℹ 55 more rows</code></pre>
</div>
</div>
<p>We can also consider to use abundance to weight the result. This is called <strong>community weighted mean</strong> and it simply gives higher importance to those species that are more abundant and lower importance to the rare once. Here the abundance is approximated as percentage cover in the site.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>spe <span class="sc">%&gt;%</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(traits, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Species"</span> <span class="ot">=</span> <span class="st">"Taxon"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">meanHeight=</span> <span class="fu">mean</span>(Height, <span class="at">na.rm=</span>T),</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">meanHeight_weighted =</span> <span class="fu">weighted.mean</span>(Height, CoverPerc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">.by=</span>RELEVE_NR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 65 × 3
   RELEVE_NR meanHeight meanHeight_weighted
       &lt;dbl&gt;      &lt;dbl&gt;               &lt;dbl&gt;
 1         1       4.60               12.9 
 2         2       6.00               16.3 
 3         3       3.50               16.7 
 4         4       8.14               17.2 
 5         5       3.82               15.3 
 6         6       3.3                 9.36
 7         7       4.25               12.9 
 8         8       3.52               11.2 
 9         9       8.25               14.6 
10        10       3.53               14.9 
# ℹ 55 more rows</code></pre>
</div>
</div>
<p>You can see that the results are quite different! Note that we are in forest so we now compare together heights of trees, which are dominants, and herbs which are small and are less abundant. Especially for the CMW it plays really big role. Therefore we will now compare only for the herb-layer (6).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>spe <span class="sc">%&gt;%</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(traits, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Species"</span> <span class="ot">=</span> <span class="st">"Taxon"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Layer<span class="sc">==</span><span class="dv">6</span>)<span class="sc">%&gt;%</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">meanHeight=</span> <span class="fu">mean</span>(Height, <span class="at">na.rm=</span>T),</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">meanHeight_weighted =</span> <span class="fu">weighted.mean</span>(Height, CoverPerc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">.by=</span>RELEVE_NR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 65 × 3
   RELEVE_NR meanHeight meanHeight_weighted
       &lt;dbl&gt;      &lt;dbl&gt;               &lt;dbl&gt;
 1         1      0.379               0.367
 2         2      0.496               0.483
 3         3      0.430               0.404
 4         4      0.598               0.593
 5         5      0.563               0.527
 6         6      0.562               0.561
 7         7      0.491               0.522
 8         8      0.452               0.657
 9         9      0.492               0.481
10        10      0.539               0.555
# ℹ 55 more rows</code></pre>
</div>
</div>
<p>In the same way we can calculate community means across more variables. Here we will try the <strong>Ellenberg indicator values</strong> (abbreviated as EIV, measures of species demands for the particular factors, the higher value mean higher demands or affinity to habitats with higher values of these environmental factors). We will apply them just for presences of species, so no weights. Therefore we do not need to care that much for the differences among layers. However, we will keep each species only once (list of unique species for each plot), so we will remove information about layers first and use distinct. Alternative is to add #filter(Layer==6)%&gt;% if we want to focus on herb-layer only</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>spe <span class="sc">%&gt;%</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(traits, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Species"</span> <span class="ot">=</span> <span class="st">"Taxon"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Layer)<span class="sc">%&gt;%</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()<span class="sc">%&gt;%</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"EIV"</span>),mean, <span class="at">na.rm=</span>T),</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">.by=</span>RELEVE_NR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 65 × 5
   RELEVE_NR EIV_Light EIV_Moisture EIV_Reaction EIV_Nutrients
       &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;         &lt;dbl&gt;
 1         1      5.10         4.66         6.51          4.95
 2         2      4.94         4.82         4.94          4.29
 3         3      4.94         4.81         4.94          4.38
 4         4      5.27         4.55         5.68          4.27
 5         5      6.07         4.2          5.53          3.87
 6         6      5.74         4.53         6.32          5.16
 7         7      5.81         4.43         6.19          4.86
 8         8      5.21         4.62         5.42          4.62
 9         9      5.19         4.58         5.81          4.5 
10        10      6.35         3.76         6.12          3.88
# ℹ 55 more rows</code></pre>
</div>
</div>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">5.6 Exercises</h2>
<p>1. Do a bit more with <strong>Forest understory</strong> data. Upload the env file called <code>Axmanova-Forest-env.xlsx</code> create two subsets: <em>forest1</em>, where you select PlotID=RELEVE_NR, ForestType, ForestTypeName and <em>forest2</em>, with columns ForestType, pH_KCl, Biomass &gt; Now use left_join to match forest2 to forest1. What happened? Check how many times there are rows with the same PlotID using some simple functions.</p>
<p>2. Upload the data from <strong>Lepidoptera</strong> folder . First the env data &gt; check the structure. The structure is inverted and we will first transpose it to be able to work with it normally.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>env<span class="ot">&lt;-</span> <span class="fu">read_xlsx</span>(<span class="st">"data/lepidoptera/env_char_MSVejnoha.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_to_rownames</span>(<span class="at">var =</span> <span class="st">"Site"</span>) <span class="sc">%&gt;%</span>  <span class="co"># move 'Site' column to row names</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>() <span class="sc">%&gt;%</span>                               <span class="co"># transpose like Excel</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span>                   <span class="co"># back to data frame</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"Site"</span>) <span class="sc">%&gt;%</span>  <span class="co"># make the row names a column again</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()<span class="sc">%&gt;%</span> </span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">view</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now look at the tibble again. Since we went through the step with dataframe, everything is changed to a text. Add one more row to change everything to numeric (<em>as.numeric</em>) except for the first column called Site (ID of the site) &gt;&gt; check the histogram of the cover of trees across sites &gt;&gt; prepare a new variable called tree_cover_groups corresponding to low/medium/high cover of tress (select the tresholds based on the histogram) &gt; filter out the group with only low cover &gt;&gt; Import the spe data and filter to have the same sites in both files</p>
<p>3. Upload <strong>Penguins data</strong> &gt; check names (penguins) &gt; calculate mean weight and SD of weight for different penguin species &gt; visualise the results by ggplot (geom_col).</p>
<p>4. Stay with Penguins, count how many individuals are at each island and to which species they belong. &gt; use a ggplot to visualise this. *Prepare a wide format matrix with islands as rows x species as names, where values will be counts of individuals.</p>
<p>5. Get back to <strong>Forest understory</strong> species file. Axmanova-Forest-spe.xlsx In the data you can see which species occur in the tree layer (=1) &gt; prepare a table where for each plotID you will have in another column a single name of the tree dominant, i.e.&nbsp;tree with highest cover &gt; append it to env data &gt; summarise counts of plots with each of the dominant *alternatively you can prepare a script, where all spe data handling will be a part of pipeline of env data handling</p>
<p>6.Use forest datasets - species and traits &gt; calculate community mean and community weighted mean for SeedMass. *create boxplots for these means within forest types (info about forest type is available in env file).</p>
</section>
<section id="further-reading" class="level2">
<h2 class="anchored" data-anchor-id="further-reading">5.7 Further reading</h2>
<p>Chapter in R for data science <a href="https://r4ds.hadley.nz/joins.html" class="uri">https://r4ds.hadley.nz/joins.html</a></p>
<p>Summarise <a href="https://dplyr.tidyverse.org/reference/summarise.html" class="uri">https://dplyr.tidyverse.org/reference/summarise.html</a></p>
<p>Summarise multiple columns <a href="https://dplyr.tidyverse.org/reference/summarise_all.html" class="uri">https://dplyr.tidyverse.org/reference/summarise_all.html</a></p>
<!-- frogID_data <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2025/2025-09-02/frogID_data.csv') -->
<!-- frog_names <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2025/2025-09-02/frog_names.csv') -->
<!-- # feederwatch - left_join, filter, maps -->
<!-- # https://github.com/rfordatascience/tidytuesday/blob/main/data/2023/2023-01-10/readme.md -->
<!-- # nps_usa - filtering, maps -->
<!-- # https://github.com/rfordatascience/tidytuesday/blob/main/data/2024/2024-10-08/readme.md -->
<!-- # bird collisions -->
<!-- # https://github.com/rfordatascience/tidytuesday/tree/main/data/2019/2019-04-30 -->
<!-- # numbats <- read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2023/2023-03-07/numbats.csv') -->
<!-- ADD keep all - distinct, -->
<!--calculate relative share of some group of plants / add info on status or threatened status / calculate total cover in plot and cover of the species classified as alien, or redlist   -->


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This page is built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>




</body></html>